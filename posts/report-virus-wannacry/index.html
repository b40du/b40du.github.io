<!DOCTYPE html>
<html><head>
<title>病毒分析 之 Wannacry勒索病毒</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="病毒分析报告-Wannacry勒索病毒-技术分享">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">











<script src="/vendor/js/jquery.min.js" ></script>
<script src="/vendor/js/popper.min.js" ></script>
<script src="/vendor/js/bootstrap.min.js" ></script>
<script src="/vendor/js/smooth-scroll.polyfills.min.js" ></script>
<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
<script src="/vendor/js/vue.min.js" ></script>






<link rel="stylesheet" href="https://b40du.github.io/scss/journal.min.47aa1ffb60880ad8c72feecd6962a14331eca7a7a30e08354a1ca91009b8bc5b.css" integrity="sha256-R6of&#43;2CICtjHL&#43;7NaWKhQzHsp6ejDgg1ShypEAm4vFs=" media="screen">



<link rel="stylesheet" href="https://b40du.github.io/scss/dark-mode.min.b13808e7c98cd5aa981a3822fd3421e26f1015876bb15a3fbf8ed5991c382367.css" integrity="sha256-sTgI58mM1aqYGjgi/TQh4m8QFYdrsVo/v47VmRw4I2c=" media="screen">


<script src="https://b40du.github.io/js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons");
</script>




  
    <script src="https://b40du.github.io/js/toc-collapse.js"></script>
  










</head><body>
    	<div id="app"><div ref="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://b40du.github.io">
    
        <div class="nav-title">
            爆肚的杂货铺
        </div>
        
        <div class="nav-subtitle">
            b40du&#39;s blog
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/posts">
                归档
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                分类
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                标签
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/about">
                关于
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS订阅
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	This is a customized copyright.
	

    </div>
    
</div><div ref="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#1-%e5%89%8d%e8%a8%80" onclick="collapseOthers(`#1-前言-nav`)" id="1-前言-nav">
									1. 前言
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#2-%e6%a0%b7%e6%9c%ac%e6%a6%82%e5%86%b5" onclick="collapseOthers(`#2-样本概况-nav`)" id="2-样本概况-nav">
									2. 样本概况
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#3-%e5%9f%ba%e7%a1%80%e5%88%86%e6%9e%90" onclick="collapseOthers(`#3-基础分析-nav`)" id="3-基础分析-nav">
									3. 基础分析
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#31-%e5%a3%b3%e4%bf%a1%e6%81%af" onclick="collapseOthers(`#31-壳信息-nav`)" id="31-壳信息-nav">
									3.1 壳信息
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#32-%e5%8c%ba%e6%ae%b5%e4%bf%a1%e6%81%af" onclick="collapseOthers(`#32-区段信息-nav`)" id="32-区段信息-nav">
									3.2 区段信息
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#33-%e5%8a%a0%e5%af%86%e7%ae%97%e6%b3%95%e4%bf%a1%e6%81%af" onclick="collapseOthers(`#33-加密算法信息-nav`)" id="33-加密算法信息-nav">
									3.3 加密算法信息
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#34-%e5%af%bc%e5%85%a5%e8%a1%a8%e4%bf%a1%e6%81%af" onclick="collapseOthers(`#34-导入表信息-nav`)" id="34-导入表信息-nav">
									3.4 导入表信息
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#35-%e8%b5%84%e6%ba%90%e8%a1%a8%e4%bf%a1%e6%81%af" onclick="collapseOthers(`#35-资源表信息-nav`)" id="35-资源表信息-nav">
									3.5 资源表信息
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#4-%e8%a1%8c%e4%b8%ba%e5%88%86%e6%9e%90" onclick="collapseOthers(`#4-行为分析-nav`)" id="4-行为分析-nav">
									4. 行为分析
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#41-%e6%96%87%e4%bb%b6%e6%93%8d%e4%bd%9c" onclick="collapseOthers(`#41-文件操作-nav`)" id="41-文件操作-nav">
									4.1 文件操作
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#42-%e6%b3%a8%e5%86%8c%e8%a1%a8%e6%93%8d%e4%bd%9c" onclick="collapseOthers(`#42-注册表操作-nav`)" id="42-注册表操作-nav">
									4.2 注册表操作
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#43-%e8%bf%9b%e7%a8%8b%e6%93%8d%e4%bd%9c" onclick="collapseOthers(`#43-进程操作-nav`)" id="43-进程操作-nav">
									4.3 进程操作
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#44-%e7%bd%91%e7%bb%9c%e6%93%8d%e4%bd%9c" onclick="collapseOthers(`#44-网络操作-nav`)" id="44-网络操作-nav">
									4.4 网络操作
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#5-%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90" onclick="collapseOthers(`#5-代码分析-nav`)" id="5-代码分析-nav">
									5. 代码分析
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#51-wcryexe%e5%88%86%e6%9e%90%e7%97%85%e6%af%92%e4%b8%bb%e7%a8%8b%e5%ba%8f" onclick="collapseOthers(`#51-wcryexe分析病毒主程序-nav`)" id="51-wcryexe分析病毒主程序-nav">
									5.1 wcry.exe分析——病毒主程序
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#511-wcryexe%e7%9a%84%e4%b8%bb%e4%bd%93%e9%80%bb%e8%be%91" onclick="collapseOthers(`#511-wcryexe的主体逻辑-nav`)" id="511-wcryexe的主体逻辑-nav">
									5.1.1 wcry.exe的主体逻辑
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#512-sub_401225getcharacter%e8%8e%b7%e5%8f%96%e5%ad%97%e7%ac%a6%e4%b8%b2" onclick="collapseOthers(`#512-sub_401225getcharacter获取字符串-nav`)" id="512-sub_401225getcharacter获取字符串-nav">
									5.1.2 sub_401225（GetCharacter）：获取字符串
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#513-sub_4010fdsetregistry%e8%ae%be%e7%bd%ae%e6%b3%a8%e5%86%8c%e8%a1%a8%e9%a1%b9" onclick="collapseOthers(`#513-sub_4010fdsetregistry设置注册表项-nav`)" id="513-sub_4010fdsetregistry设置注册表项-nav">
									5.1.3 sub_4010FD（SetRegistry）：设置注册表项
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#514-sub_401dabfreefiles%e9%87%8a%e6%94%be%e8%b5%84%e6%ba%90%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#514-sub_401dabfreefiles释放资源文件-nav`)" id="514-sub_401dabfreefiles释放资源文件-nav">
									5.1.4 sub_401DAB（FreeFiles）：释放资源文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#515-sub_401e9eoverwrite%e9%87%8d%e5%86%99wnry%e6%96%87%e4%bb%b6%e5%86%99%e5%85%a5%e6%af%94%e7%89%b9%e5%b8%81%e8%b4%a6%e6%88%b7%e4%bf%a1%e6%81%af" onclick="collapseOthers(`#515-sub_401e9eoverwrite重写wnry文件写入比特币账户信息-nav`)" id="515-sub_401e9eoverwrite重写wnry文件写入比特币账户信息-nav">
									5.1.5 sub_401E9E（OverWrite）：重写wnry文件，写入比特币账户信息
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#516-sub_401064hideandcreate%e4%bb%a5%e4%b8%8d%e6%98%be%e7%a4%ba%e5%91%bd%e4%bb%a4%e8%a1%8c%e7%aa%97%e5%8f%a3%e7%9a%84%e6%96%b9%e5%bc%8f%e6%89%a7%e8%a1%8c%e5%91%bd%e4%bb%a4" onclick="collapseOthers(`#516-sub_401064hideandcreate以不显示命令行窗口的方式执行命令-nav`)" id="516-sub_401064hideandcreate以不显示命令行窗口的方式执行命令-nav">
									5.1.6 sub_401064（HideAndCreate）：以不显示命令行窗口的方式执行命令
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#517-sub_40170agetapis%e8%8e%b7%e5%8f%96api%e7%9a%84%e5%9c%b0%e5%9d%80" onclick="collapseOthers(`#517-sub_40170agetapis获取api的地址-nav`)" id="517-sub_40170agetapis获取api的地址-nav">
									5.1.7 sub_40170A（GetAPIs）：获取API的地址
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#518-sub_4012fdinitcriticalsection%e5%88%9d%e5%a7%8b%e5%8c%96%e4%b8%b4%e7%95%8c%e5%8c%ba" onclick="collapseOthers(`#518-sub_4012fdinitcriticalsection初始化临界区-nav`)" id="518-sub_4012fdinitcriticalsection初始化临界区-nav">
									5.1.8 sub_4012FD（InitCriticalSection）：初始化临界区
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#519-sub_401437importkeyandallocmemory%e5%af%bc%e5%85%a5%e5%af%86%e9%92%a5%e5%b9%b6%e5%88%86%e9%85%8d%e5%85%a8%e5%b1%80%e5%a0%86%e5%86%85%e5%ad%98" onclick="collapseOthers(`#519-sub_401437importkeyandallocmemory导入密钥并分配全局堆内存-nav`)" id="519-sub_401437importkeyandallocmemory导入密钥并分配全局堆内存-nav">
									5.1.9 sub_401437（ImportKeyAndAllocMemory）：导入密钥并分配全局堆内存
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5110-sub_4014a6decodefile%e4%bb%8etwnry%e6%96%87%e4%bb%b6%e4%b8%ad%e8%a7%a3%e5%af%86%e5%87%ba%e4%b8%80%e4%b8%aadll%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#5110-sub_4014a6decodefile从twnry文件中解密出一个dll文件-nav`)" id="5110-sub_4014a6decodefile从twnry文件中解密出一个dll文件-nav">
									5.1.10 sub_4014A6（DecodeFile）：从t.wnry文件中解密出一个dll文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5111-sub_4021bdallocandwritememory%e7%94%b3%e8%af%b7%e5%a0%86%e7%a9%ba%e9%97%b4%e5%b9%b6%e5%86%99%e5%85%a5%e6%95%b0%e6%8d%ae" onclick="collapseOthers(`#5111-sub_4021bdallocandwritememory申请堆空间并写入数据-nav`)" id="5111-sub_4021bdallocandwritememory申请堆空间并写入数据-nav">
									5.1.11 sub_4021BD（AllocAndWriteMemory）：申请堆空间并写入数据
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5112-sub_402924getexportfuncaddr%e8%8e%b7%e5%8f%96%e5%af%bc%e5%87%ba%e5%87%bd%e6%95%b0%e7%9a%84%e5%9c%b0%e5%9d%80" onclick="collapseOthers(`#5112-sub_402924getexportfuncaddr获取导出函数的地址-nav`)" id="5112-sub_402924getexportfuncaddr获取导出函数的地址-nav">
									5.1.12 sub_402924（GetExportFuncAddr）：获取导出函数的地址
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#52-twnrydll%e5%88%86%e6%9e%90%e7%97%85%e6%af%92%e6%a0%b8%e5%bf%83" onclick="collapseOthers(`#52-twnrydll分析病毒核心-nav`)" id="52-twnrydll分析病毒核心-nav">
									5.2 t.wnry.dll分析——病毒核心
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#521-twnrydll%e7%9a%84%e4%b8%bb%e4%bd%93%e9%80%bb%e8%be%91" onclick="collapseOthers(`#521-twnrydll的主体逻辑-nav`)" id="521-twnrydll的主体逻辑-nav">
									5.2.1 t.wnry.dll的主体逻辑
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#522-sub_10004690createfirstmutex%e5%88%9b%e5%bb%ba%e7%ac%ac%e4%b8%80%e4%b8%aa%e4%ba%92%e6%96%a5%e4%bd%93" onclick="collapseOthers(`#522-sub_10004690createfirstmutex创建第一个互斥体-nav`)" id="522-sub_10004690createfirstmutex创建第一个互斥体-nav">
									5.2.2 sub_10004690（CreateFirstMutex）：创建第一个互斥体
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#523-sub_10001000readfiletomemory%e8%af%bb%e5%8f%96%e6%96%87%e4%bb%b6%e5%88%b0%e5%86%85%e5%ad%98" onclick="collapseOthers(`#523-sub_10001000readfiletomemory读取文件到内存-nav`)" id="523-sub_10001000readfiletomemory读取文件到内存-nav">
									5.2.3 sub_10001000（ReadFileToMemory）：读取文件到内存
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#524-sub_100012d0getusersidandcmpwithsys%e8%af%bb%e5%8f%96sid%e5%b9%b6%e5%81%9a%e6%af%94%e8%be%83" onclick="collapseOthers(`#524-sub_100012d0getusersidandcmpwithsys读取sid并做比较-nav`)" id="524-sub_100012d0getusersidandcmpwithsys读取sid并做比较-nav">
									5.2.4 sub_100012D0（GetUserSIDAndCmpWithSys）：读取SID并做比较
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#525-sub_10004600createsecondmutex%e5%88%9b%e5%bb%ba%e7%ac%ac%e4%ba%8c%e4%b8%aa%e4%ba%92%e6%96%a5%e4%bd%93" onclick="collapseOthers(`#525-sub_10004600createsecondmutex创建第二个互斥体-nav`)" id="525-sub_10004600createsecondmutex创建第二个互斥体-nav">
									5.2.5 sub_10004600（CreateSecondMutex）：创建第二个互斥体
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#526-sub_10004500checkfileisexist%e6%9f%a5%e7%9c%8b%e6%96%87%e4%bb%b6%e6%98%af%e5%90%a6%e5%ad%98%e5%9c%a8" onclick="collapseOthers(`#526-sub_10004500checkfileisexist查看文件是否存在-nav`)" id="526-sub_10004500checkfileisexist查看文件是否存在-nav">
									5.2.6 sub_10004500（CheckFileIsExist）：查看文件是否存在
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#527-sub_10003ac0createpkyandeky%e5%88%9b%e5%bb%ba%e4%b8%a4%e4%b8%aa%e5%af%86%e9%92%a5" onclick="collapseOthers(`#527-sub_10003ac0createpkyandeky创建两个密钥-nav`)" id="527-sub_10003ac0createpkyandeky创建两个密钥-nav">
									5.2.7 sub_10003AC0（CreatePkyAndEky）：创建两个密钥
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#528-sub_10004790createresfile%e5%88%9b%e5%bb%ba00000000res%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#528-sub_10004790createresfile创建00000000res文件-nav`)" id="528-sub_10004790createresfile创建00000000res文件-nav">
									5.2.8 sub_10004790（CreateResFile）：创建00000000.res文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#529-sub_100045c0checkdky5s%e6%a3%80%e6%b5%8b%e6%98%af%e5%90%a6%e5%ad%98%e5%9c%a800000000dky" onclick="collapseOthers(`#529-sub_100045c0checkdky5s检测是否存在00000000dky-nav`)" id="529-sub_100045c0checkdky5s检测是否存在00000000dky-nav">
									5.2.9 sub_100045C0（CheckDky5s）：检测是否存在00000000.dky
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5210-sub_10005730encodeallfiles%e6%a3%80%e6%b5%8b%e6%9c%89%e6%97%a0%e6%96%b0%e7%a3%81%e7%9b%98%e5%b9%b6%e5%8a%a0%e5%af%86" onclick="collapseOthers(`#5210-sub_10005730encodeallfiles检测有无新磁盘并加密-nav`)" id="5210-sub_10005730encodeallfiles检测有无新磁盘并加密-nav">
									5.2.10 sub_10005730（EncodeAllFiles）：检测有无新磁盘并加密
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5211-sub_10005300runtaskdlexe%e9%9a%90%e8%97%8f%e7%9a%84%e6%96%b9%e5%bc%8f%e5%90%af%e5%8a%a8taskdlexe" onclick="collapseOthers(`#5211-sub_10005300runtaskdlexe隐藏的方式启动taskdlexe-nav`)" id="5211-sub_10005300runtaskdlexe隐藏的方式启动taskdlexe-nav">
									5.2.11 sub_10005300（RunTaskdlExe）：隐藏的方式启动taskdl.exe
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5212-sub_10004990runexeandsetreg%e8%bf%90%e8%a1%8c%e6%96%87%e4%bb%b6%e5%92%8c%e8%ae%be%e7%bd%ae%e6%b3%a8%e5%86%8c%e8%a1%a8" onclick="collapseOthers(`#5212-sub_10004990runexeandsetreg运行文件和设置注册表-nav`)" id="5212-sub_10004990runexeandsetreg运行文件和设置注册表-nav">
									5.2.12 sub_10004990（RunExeAndSetReg）：运行文件和设置注册表
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5213-sub_10004890runtaskseanddecryptor%e5%90%af%e5%8a%a8%e4%b8%a4%e4%b8%aaexe%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#5213-sub_10004890runtaskseanddecryptor启动两个exe文件-nav`)" id="5213-sub_10004890runtaskseanddecryptor启动两个exe文件-nav">
									5.2.13 sub_10004890（RunTaskseAndDecryptor）：启动两个exe文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5214-sub_100047f0setregedit%e8%ae%be%e7%bd%ae%e6%b3%a8%e5%86%8c%e8%a1%a8%e5%90%af%e5%8a%a8%e9%a1%b9" onclick="collapseOthers(`#5214-sub_100047f0setregedit设置注册表启动项-nav`)" id="5214-sub_100047f0setregedit设置注册表启动项-nav">
									5.2.14 sub_100047F0（SetRegedit）：设置注册表启动项
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5215-sub_100057c0createotherfiles%e5%88%9b%e5%bb%ba%e5%85%b6%e4%bb%96%e7%9a%84%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#5215-sub_100057c0createotherfiles创建其他的文件-nav`)" id="5215-sub_100057c0createotherfiles创建其他的文件-nav">
									5.2.15 sub_100057C0（CreateOtherFiles）：创建其他的文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5216-sub_10004cd0createexeandlnk%e5%88%9b%e5%bb%bawanadecryptorexe%e5%92%8c%e5%85%b6lnk" onclick="collapseOthers(`#5216-sub_10004cd0createexeandlnk创建wanadecryptorexe和其lnk-nav`)" id="5216-sub_10004cd0createexeandlnk创建wanadecryptorexe和其lnk-nav">
									5.2.16 sub_10004CD0（CreateExeAndLnk）：创建@WanaDecryptor@.exe和其.Lnk
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5217-sub_10004df0createreadme%e5%88%9b%e5%bb%baplease_read_metxt" onclick="collapseOthers(`#5217-sub_10004df0createreadme创建please_read_metxt-nav`)" id="5217-sub_10004df0createreadme创建please_read_metxt-nav">
									5.2.17 sub_10004DF0（CreateReadMe）：创建@Please_Read_Me@.txt
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5218-sub_10005480encodeotherfiles%e5%8a%a0%e5%af%86%e5%85%b6%e4%bb%96%e7%9a%84%e6%89%80%e6%9c%89%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#5218-sub_10005480encodeotherfiles加密其他的所有文件-nav`)" id="5218-sub_10005480encodeotherfiles加密其他的所有文件-nav">
									5.2.18 sub_10005480（EncodeOtherFiles）：加密其他的所有文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#52181-sub_100027f0encodedifferentfiles%e6%a0%b9%e6%8d%ae%e4%b8%8d%e5%90%8c%e8%b7%af%e5%be%84%e5%8a%a0%e5%af%86%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#52181-sub_100027f0encodedifferentfiles根据不同路径加密文件-nav`)" id="52181-sub_100027f0encodedifferentfiles根据不同路径加密文件-nav">
									5.2.18.1 sub_100027F0（EncodeDifferentFiles）：根据不同路径加密文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#52182-sub_10002300realencode%e5%ae%9e%e9%99%85%e5%8a%a0%e5%af%86%e5%87%bd%e6%95%b01" onclick="collapseOthers(`#52182-sub_10002300realencode实际加密函数1-nav`)" id="52182-sub_10002300realencode实际加密函数1-nav">
									5.2.18.2 sub_10002300（RealEncode）：实际加密函数（1）
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#52183-sub_10002300realencode%e5%ae%9e%e9%99%85%e5%8a%a0%e5%af%86%e5%87%bd%e6%95%b02" onclick="collapseOthers(`#52183-sub_10002300realencode实际加密函数2-nav`)" id="52183-sub_10002300realencode实际加密函数2-nav">
									5.2.18.3 sub_10002300（RealEncode）：实际加密函数（2）
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#52184-sub_10002940realencodeothers%e5%8a%a0%e5%af%86%e5%85%b6%e4%bb%96%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#52184-sub_10002940realencodeothers加密其他文件-nav`)" id="52184-sub_10002940realencodeothers加密其他文件-nav">
									5.2.18.4 sub_10002940（RealEncodeOthers）：加密其他文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#52185-sub_10002300realencode%e5%ae%9e%e9%99%85%e5%8a%a0%e5%af%86%e5%87%bd%e6%95%b03" onclick="collapseOthers(`#52185-sub_10002300realencode实际加密函数3-nav`)" id="52185-sub_10002300realencode实际加密函数3-nav">
									5.2.18.5 sub_10002300（RealEncode）：实际加密函数（3）
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#53-taskdlexe-%e5%88%86%e6%9e%90%e5%b1%80%e9%83%a8%e5%8a%9f%e8%83%bd" onclick="collapseOthers(`#53-taskdlexe-分析局部功能-nav`)" id="53-taskdlexe-分析局部功能-nav">
									5.3 taskdl.exe 分析——局部功能
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#531-sub_401080deletefile%e6%b8%85%e7%a9%bawncry%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#531-sub_401080deletefile清空wncry文件-nav`)" id="531-sub_401080deletefile清空wncry文件-nav">
									5.3.1 sub_401080（DeleteFile）：清空.WNCRY文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#5311-sub_401000getrecyclepathandtempdirectorypath%e8%8e%b7%e5%8f%96%e4%b8%a4%e4%b8%aa%e8%b7%af%e5%be%84" onclick="collapseOthers(`#5311-sub_401000getrecyclepathandtempdirectorypath获取两个路径-nav`)" id="5311-sub_401000getrecyclepathandtempdirectorypath获取两个路径-nav">
									5.3.1.1 sub_401000（GetRecyclePathAndTempDirectoryPath）：获取两个路径
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5312-sub_402014findfirstfilew%e9%81%8d%e5%8e%86%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#5312-sub_402014findfirstfilew遍历文件-nav`)" id="5312-sub_402014findfirstfilew遍历文件-nav">
									5.3.1.2 sub_402014（FindFirstFileW）：遍历文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5313-sub_402008deletefilew%e5%88%a0%e9%99%a4%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#5313-sub_402008deletefilew删除文件-nav`)" id="5313-sub_402008deletefilew删除文件-nav">
									5.3.1.3 sub_402008（DeleteFileW）：删除文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#54-taskseexe-%e5%88%86%e6%9e%90%e5%b1%80%e9%83%a8%e5%8a%9f%e8%83%bd" onclick="collapseOthers(`#54-taskseexe-分析局部功能-nav`)" id="54-taskseexe-分析局部功能-nav">
									5.4 taskse.exe 分析——局部功能
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#541-sub_401000changeprivilege_%e6%9b%b4%e6%94%b9%e6%9d%83%e9%99%90%e5%87%bd%e6%95%b0" onclick="collapseOthers(`#541-sub_401000changeprivilege_更改权限函数-nav`)" id="541-sub_401000changeprivilege_更改权限函数-nav">
									5.4.1 sub_401000（ChangePrivilege_）：更改权限函数
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#6-%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88" onclick="collapseOthers(`#6-解决方案-nav`)" id="6-解决方案-nav">
									6. 解决方案
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#61-%e6%9c%aa%e6%84%9f%e6%9f%93%e4%b8%bb%e6%9c%ba" onclick="collapseOthers(`#61-未感染主机-nav`)" id="61-未感染主机-nav">
									6.1 未感染主机
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#62-%e5%b7%b2%e6%84%9f%e6%9f%93%e4%b8%bb%e6%9c%ba" onclick="collapseOthers(`#62-已感染主机-nav`)" id="62-已感染主机-nav">
									6.2 已感染主机
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#63-%e4%b8%93%e6%9d%80%e5%b7%a5%e5%85%b7" onclick="collapseOthers(`#63-专杀工具-nav`)" id="63-专杀工具-nav">
									6.3 专杀工具
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a class="pagination-action" v-on:click="toggleDarkMode">
            <i class="material-icons pagination-action-icon" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons pagination-action-icon" v-else="isDarkMode">
                brightness_7
            </i>
        </a>
        
        
    </div>
</div><div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/posts">
                    归档
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    分类
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    标签
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/about">
                    关于
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS订阅
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#1-%e5%89%8d%e8%a8%80" onclick="collapseOthers(`#1-前言-nav`)" id="1-前言-nav">
									1. 前言
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#2-%e6%a0%b7%e6%9c%ac%e6%a6%82%e5%86%b5" onclick="collapseOthers(`#2-样本概况-nav`)" id="2-样本概况-nav">
									2. 样本概况
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#3-%e5%9f%ba%e7%a1%80%e5%88%86%e6%9e%90" onclick="collapseOthers(`#3-基础分析-nav`)" id="3-基础分析-nav">
									3. 基础分析
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#31-%e5%a3%b3%e4%bf%a1%e6%81%af" onclick="collapseOthers(`#31-壳信息-nav`)" id="31-壳信息-nav">
									3.1 壳信息
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#32-%e5%8c%ba%e6%ae%b5%e4%bf%a1%e6%81%af" onclick="collapseOthers(`#32-区段信息-nav`)" id="32-区段信息-nav">
									3.2 区段信息
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#33-%e5%8a%a0%e5%af%86%e7%ae%97%e6%b3%95%e4%bf%a1%e6%81%af" onclick="collapseOthers(`#33-加密算法信息-nav`)" id="33-加密算法信息-nav">
									3.3 加密算法信息
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#34-%e5%af%bc%e5%85%a5%e8%a1%a8%e4%bf%a1%e6%81%af" onclick="collapseOthers(`#34-导入表信息-nav`)" id="34-导入表信息-nav">
									3.4 导入表信息
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#35-%e8%b5%84%e6%ba%90%e8%a1%a8%e4%bf%a1%e6%81%af" onclick="collapseOthers(`#35-资源表信息-nav`)" id="35-资源表信息-nav">
									3.5 资源表信息
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#4-%e8%a1%8c%e4%b8%ba%e5%88%86%e6%9e%90" onclick="collapseOthers(`#4-行为分析-nav`)" id="4-行为分析-nav">
									4. 行为分析
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#41-%e6%96%87%e4%bb%b6%e6%93%8d%e4%bd%9c" onclick="collapseOthers(`#41-文件操作-nav`)" id="41-文件操作-nav">
									4.1 文件操作
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#42-%e6%b3%a8%e5%86%8c%e8%a1%a8%e6%93%8d%e4%bd%9c" onclick="collapseOthers(`#42-注册表操作-nav`)" id="42-注册表操作-nav">
									4.2 注册表操作
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#43-%e8%bf%9b%e7%a8%8b%e6%93%8d%e4%bd%9c" onclick="collapseOthers(`#43-进程操作-nav`)" id="43-进程操作-nav">
									4.3 进程操作
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#44-%e7%bd%91%e7%bb%9c%e6%93%8d%e4%bd%9c" onclick="collapseOthers(`#44-网络操作-nav`)" id="44-网络操作-nav">
									4.4 网络操作
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#5-%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90" onclick="collapseOthers(`#5-代码分析-nav`)" id="5-代码分析-nav">
									5. 代码分析
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#51-wcryexe%e5%88%86%e6%9e%90%e7%97%85%e6%af%92%e4%b8%bb%e7%a8%8b%e5%ba%8f" onclick="collapseOthers(`#51-wcryexe分析病毒主程序-nav`)" id="51-wcryexe分析病毒主程序-nav">
									5.1 wcry.exe分析——病毒主程序
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#511-wcryexe%e7%9a%84%e4%b8%bb%e4%bd%93%e9%80%bb%e8%be%91" onclick="collapseOthers(`#511-wcryexe的主体逻辑-nav`)" id="511-wcryexe的主体逻辑-nav">
									5.1.1 wcry.exe的主体逻辑
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#512-sub_401225getcharacter%e8%8e%b7%e5%8f%96%e5%ad%97%e7%ac%a6%e4%b8%b2" onclick="collapseOthers(`#512-sub_401225getcharacter获取字符串-nav`)" id="512-sub_401225getcharacter获取字符串-nav">
									5.1.2 sub_401225（GetCharacter）：获取字符串
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#513-sub_4010fdsetregistry%e8%ae%be%e7%bd%ae%e6%b3%a8%e5%86%8c%e8%a1%a8%e9%a1%b9" onclick="collapseOthers(`#513-sub_4010fdsetregistry设置注册表项-nav`)" id="513-sub_4010fdsetregistry设置注册表项-nav">
									5.1.3 sub_4010FD（SetRegistry）：设置注册表项
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#514-sub_401dabfreefiles%e9%87%8a%e6%94%be%e8%b5%84%e6%ba%90%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#514-sub_401dabfreefiles释放资源文件-nav`)" id="514-sub_401dabfreefiles释放资源文件-nav">
									5.1.4 sub_401DAB（FreeFiles）：释放资源文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#515-sub_401e9eoverwrite%e9%87%8d%e5%86%99wnry%e6%96%87%e4%bb%b6%e5%86%99%e5%85%a5%e6%af%94%e7%89%b9%e5%b8%81%e8%b4%a6%e6%88%b7%e4%bf%a1%e6%81%af" onclick="collapseOthers(`#515-sub_401e9eoverwrite重写wnry文件写入比特币账户信息-nav`)" id="515-sub_401e9eoverwrite重写wnry文件写入比特币账户信息-nav">
									5.1.5 sub_401E9E（OverWrite）：重写wnry文件，写入比特币账户信息
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#516-sub_401064hideandcreate%e4%bb%a5%e4%b8%8d%e6%98%be%e7%a4%ba%e5%91%bd%e4%bb%a4%e8%a1%8c%e7%aa%97%e5%8f%a3%e7%9a%84%e6%96%b9%e5%bc%8f%e6%89%a7%e8%a1%8c%e5%91%bd%e4%bb%a4" onclick="collapseOthers(`#516-sub_401064hideandcreate以不显示命令行窗口的方式执行命令-nav`)" id="516-sub_401064hideandcreate以不显示命令行窗口的方式执行命令-nav">
									5.1.6 sub_401064（HideAndCreate）：以不显示命令行窗口的方式执行命令
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#517-sub_40170agetapis%e8%8e%b7%e5%8f%96api%e7%9a%84%e5%9c%b0%e5%9d%80" onclick="collapseOthers(`#517-sub_40170agetapis获取api的地址-nav`)" id="517-sub_40170agetapis获取api的地址-nav">
									5.1.7 sub_40170A（GetAPIs）：获取API的地址
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#518-sub_4012fdinitcriticalsection%e5%88%9d%e5%a7%8b%e5%8c%96%e4%b8%b4%e7%95%8c%e5%8c%ba" onclick="collapseOthers(`#518-sub_4012fdinitcriticalsection初始化临界区-nav`)" id="518-sub_4012fdinitcriticalsection初始化临界区-nav">
									5.1.8 sub_4012FD（InitCriticalSection）：初始化临界区
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#519-sub_401437importkeyandallocmemory%e5%af%bc%e5%85%a5%e5%af%86%e9%92%a5%e5%b9%b6%e5%88%86%e9%85%8d%e5%85%a8%e5%b1%80%e5%a0%86%e5%86%85%e5%ad%98" onclick="collapseOthers(`#519-sub_401437importkeyandallocmemory导入密钥并分配全局堆内存-nav`)" id="519-sub_401437importkeyandallocmemory导入密钥并分配全局堆内存-nav">
									5.1.9 sub_401437（ImportKeyAndAllocMemory）：导入密钥并分配全局堆内存
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5110-sub_4014a6decodefile%e4%bb%8etwnry%e6%96%87%e4%bb%b6%e4%b8%ad%e8%a7%a3%e5%af%86%e5%87%ba%e4%b8%80%e4%b8%aadll%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#5110-sub_4014a6decodefile从twnry文件中解密出一个dll文件-nav`)" id="5110-sub_4014a6decodefile从twnry文件中解密出一个dll文件-nav">
									5.1.10 sub_4014A6（DecodeFile）：从t.wnry文件中解密出一个dll文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5111-sub_4021bdallocandwritememory%e7%94%b3%e8%af%b7%e5%a0%86%e7%a9%ba%e9%97%b4%e5%b9%b6%e5%86%99%e5%85%a5%e6%95%b0%e6%8d%ae" onclick="collapseOthers(`#5111-sub_4021bdallocandwritememory申请堆空间并写入数据-nav`)" id="5111-sub_4021bdallocandwritememory申请堆空间并写入数据-nav">
									5.1.11 sub_4021BD（AllocAndWriteMemory）：申请堆空间并写入数据
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5112-sub_402924getexportfuncaddr%e8%8e%b7%e5%8f%96%e5%af%bc%e5%87%ba%e5%87%bd%e6%95%b0%e7%9a%84%e5%9c%b0%e5%9d%80" onclick="collapseOthers(`#5112-sub_402924getexportfuncaddr获取导出函数的地址-nav`)" id="5112-sub_402924getexportfuncaddr获取导出函数的地址-nav">
									5.1.12 sub_402924（GetExportFuncAddr）：获取导出函数的地址
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#52-twnrydll%e5%88%86%e6%9e%90%e7%97%85%e6%af%92%e6%a0%b8%e5%bf%83" onclick="collapseOthers(`#52-twnrydll分析病毒核心-nav`)" id="52-twnrydll分析病毒核心-nav">
									5.2 t.wnry.dll分析——病毒核心
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#521-twnrydll%e7%9a%84%e4%b8%bb%e4%bd%93%e9%80%bb%e8%be%91" onclick="collapseOthers(`#521-twnrydll的主体逻辑-nav`)" id="521-twnrydll的主体逻辑-nav">
									5.2.1 t.wnry.dll的主体逻辑
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#522-sub_10004690createfirstmutex%e5%88%9b%e5%bb%ba%e7%ac%ac%e4%b8%80%e4%b8%aa%e4%ba%92%e6%96%a5%e4%bd%93" onclick="collapseOthers(`#522-sub_10004690createfirstmutex创建第一个互斥体-nav`)" id="522-sub_10004690createfirstmutex创建第一个互斥体-nav">
									5.2.2 sub_10004690（CreateFirstMutex）：创建第一个互斥体
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#523-sub_10001000readfiletomemory%e8%af%bb%e5%8f%96%e6%96%87%e4%bb%b6%e5%88%b0%e5%86%85%e5%ad%98" onclick="collapseOthers(`#523-sub_10001000readfiletomemory读取文件到内存-nav`)" id="523-sub_10001000readfiletomemory读取文件到内存-nav">
									5.2.3 sub_10001000（ReadFileToMemory）：读取文件到内存
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#524-sub_100012d0getusersidandcmpwithsys%e8%af%bb%e5%8f%96sid%e5%b9%b6%e5%81%9a%e6%af%94%e8%be%83" onclick="collapseOthers(`#524-sub_100012d0getusersidandcmpwithsys读取sid并做比较-nav`)" id="524-sub_100012d0getusersidandcmpwithsys读取sid并做比较-nav">
									5.2.4 sub_100012D0（GetUserSIDAndCmpWithSys）：读取SID并做比较
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#525-sub_10004600createsecondmutex%e5%88%9b%e5%bb%ba%e7%ac%ac%e4%ba%8c%e4%b8%aa%e4%ba%92%e6%96%a5%e4%bd%93" onclick="collapseOthers(`#525-sub_10004600createsecondmutex创建第二个互斥体-nav`)" id="525-sub_10004600createsecondmutex创建第二个互斥体-nav">
									5.2.5 sub_10004600（CreateSecondMutex）：创建第二个互斥体
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#526-sub_10004500checkfileisexist%e6%9f%a5%e7%9c%8b%e6%96%87%e4%bb%b6%e6%98%af%e5%90%a6%e5%ad%98%e5%9c%a8" onclick="collapseOthers(`#526-sub_10004500checkfileisexist查看文件是否存在-nav`)" id="526-sub_10004500checkfileisexist查看文件是否存在-nav">
									5.2.6 sub_10004500（CheckFileIsExist）：查看文件是否存在
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#527-sub_10003ac0createpkyandeky%e5%88%9b%e5%bb%ba%e4%b8%a4%e4%b8%aa%e5%af%86%e9%92%a5" onclick="collapseOthers(`#527-sub_10003ac0createpkyandeky创建两个密钥-nav`)" id="527-sub_10003ac0createpkyandeky创建两个密钥-nav">
									5.2.7 sub_10003AC0（CreatePkyAndEky）：创建两个密钥
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#528-sub_10004790createresfile%e5%88%9b%e5%bb%ba00000000res%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#528-sub_10004790createresfile创建00000000res文件-nav`)" id="528-sub_10004790createresfile创建00000000res文件-nav">
									5.2.8 sub_10004790（CreateResFile）：创建00000000.res文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#529-sub_100045c0checkdky5s%e6%a3%80%e6%b5%8b%e6%98%af%e5%90%a6%e5%ad%98%e5%9c%a800000000dky" onclick="collapseOthers(`#529-sub_100045c0checkdky5s检测是否存在00000000dky-nav`)" id="529-sub_100045c0checkdky5s检测是否存在00000000dky-nav">
									5.2.9 sub_100045C0（CheckDky5s）：检测是否存在00000000.dky
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5210-sub_10005730encodeallfiles%e6%a3%80%e6%b5%8b%e6%9c%89%e6%97%a0%e6%96%b0%e7%a3%81%e7%9b%98%e5%b9%b6%e5%8a%a0%e5%af%86" onclick="collapseOthers(`#5210-sub_10005730encodeallfiles检测有无新磁盘并加密-nav`)" id="5210-sub_10005730encodeallfiles检测有无新磁盘并加密-nav">
									5.2.10 sub_10005730（EncodeAllFiles）：检测有无新磁盘并加密
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5211-sub_10005300runtaskdlexe%e9%9a%90%e8%97%8f%e7%9a%84%e6%96%b9%e5%bc%8f%e5%90%af%e5%8a%a8taskdlexe" onclick="collapseOthers(`#5211-sub_10005300runtaskdlexe隐藏的方式启动taskdlexe-nav`)" id="5211-sub_10005300runtaskdlexe隐藏的方式启动taskdlexe-nav">
									5.2.11 sub_10005300（RunTaskdlExe）：隐藏的方式启动taskdl.exe
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5212-sub_10004990runexeandsetreg%e8%bf%90%e8%a1%8c%e6%96%87%e4%bb%b6%e5%92%8c%e8%ae%be%e7%bd%ae%e6%b3%a8%e5%86%8c%e8%a1%a8" onclick="collapseOthers(`#5212-sub_10004990runexeandsetreg运行文件和设置注册表-nav`)" id="5212-sub_10004990runexeandsetreg运行文件和设置注册表-nav">
									5.2.12 sub_10004990（RunExeAndSetReg）：运行文件和设置注册表
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5213-sub_10004890runtaskseanddecryptor%e5%90%af%e5%8a%a8%e4%b8%a4%e4%b8%aaexe%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#5213-sub_10004890runtaskseanddecryptor启动两个exe文件-nav`)" id="5213-sub_10004890runtaskseanddecryptor启动两个exe文件-nav">
									5.2.13 sub_10004890（RunTaskseAndDecryptor）：启动两个exe文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5214-sub_100047f0setregedit%e8%ae%be%e7%bd%ae%e6%b3%a8%e5%86%8c%e8%a1%a8%e5%90%af%e5%8a%a8%e9%a1%b9" onclick="collapseOthers(`#5214-sub_100047f0setregedit设置注册表启动项-nav`)" id="5214-sub_100047f0setregedit设置注册表启动项-nav">
									5.2.14 sub_100047F0（SetRegedit）：设置注册表启动项
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5215-sub_100057c0createotherfiles%e5%88%9b%e5%bb%ba%e5%85%b6%e4%bb%96%e7%9a%84%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#5215-sub_100057c0createotherfiles创建其他的文件-nav`)" id="5215-sub_100057c0createotherfiles创建其他的文件-nav">
									5.2.15 sub_100057C0（CreateOtherFiles）：创建其他的文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5216-sub_10004cd0createexeandlnk%e5%88%9b%e5%bb%bawanadecryptorexe%e5%92%8c%e5%85%b6lnk" onclick="collapseOthers(`#5216-sub_10004cd0createexeandlnk创建wanadecryptorexe和其lnk-nav`)" id="5216-sub_10004cd0createexeandlnk创建wanadecryptorexe和其lnk-nav">
									5.2.16 sub_10004CD0（CreateExeAndLnk）：创建@WanaDecryptor@.exe和其.Lnk
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5217-sub_10004df0createreadme%e5%88%9b%e5%bb%baplease_read_metxt" onclick="collapseOthers(`#5217-sub_10004df0createreadme创建please_read_metxt-nav`)" id="5217-sub_10004df0createreadme创建please_read_metxt-nav">
									5.2.17 sub_10004DF0（CreateReadMe）：创建@Please_Read_Me@.txt
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5218-sub_10005480encodeotherfiles%e5%8a%a0%e5%af%86%e5%85%b6%e4%bb%96%e7%9a%84%e6%89%80%e6%9c%89%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#5218-sub_10005480encodeotherfiles加密其他的所有文件-nav`)" id="5218-sub_10005480encodeotherfiles加密其他的所有文件-nav">
									5.2.18 sub_10005480（EncodeOtherFiles）：加密其他的所有文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#52181-sub_100027f0encodedifferentfiles%e6%a0%b9%e6%8d%ae%e4%b8%8d%e5%90%8c%e8%b7%af%e5%be%84%e5%8a%a0%e5%af%86%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#52181-sub_100027f0encodedifferentfiles根据不同路径加密文件-nav`)" id="52181-sub_100027f0encodedifferentfiles根据不同路径加密文件-nav">
									5.2.18.1 sub_100027F0（EncodeDifferentFiles）：根据不同路径加密文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#52182-sub_10002300realencode%e5%ae%9e%e9%99%85%e5%8a%a0%e5%af%86%e5%87%bd%e6%95%b01" onclick="collapseOthers(`#52182-sub_10002300realencode实际加密函数1-nav`)" id="52182-sub_10002300realencode实际加密函数1-nav">
									5.2.18.2 sub_10002300（RealEncode）：实际加密函数（1）
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#52183-sub_10002300realencode%e5%ae%9e%e9%99%85%e5%8a%a0%e5%af%86%e5%87%bd%e6%95%b02" onclick="collapseOthers(`#52183-sub_10002300realencode实际加密函数2-nav`)" id="52183-sub_10002300realencode实际加密函数2-nav">
									5.2.18.3 sub_10002300（RealEncode）：实际加密函数（2）
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#52184-sub_10002940realencodeothers%e5%8a%a0%e5%af%86%e5%85%b6%e4%bb%96%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#52184-sub_10002940realencodeothers加密其他文件-nav`)" id="52184-sub_10002940realencodeothers加密其他文件-nav">
									5.2.18.4 sub_10002940（RealEncodeOthers）：加密其他文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#52185-sub_10002300realencode%e5%ae%9e%e9%99%85%e5%8a%a0%e5%af%86%e5%87%bd%e6%95%b03" onclick="collapseOthers(`#52185-sub_10002300realencode实际加密函数3-nav`)" id="52185-sub_10002300realencode实际加密函数3-nav">
									5.2.18.5 sub_10002300（RealEncode）：实际加密函数（3）
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#53-taskdlexe-%e5%88%86%e6%9e%90%e5%b1%80%e9%83%a8%e5%8a%9f%e8%83%bd" onclick="collapseOthers(`#53-taskdlexe-分析局部功能-nav`)" id="53-taskdlexe-分析局部功能-nav">
									5.3 taskdl.exe 分析——局部功能
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#531-sub_401080deletefile%e6%b8%85%e7%a9%bawncry%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#531-sub_401080deletefile清空wncry文件-nav`)" id="531-sub_401080deletefile清空wncry文件-nav">
									5.3.1 sub_401080（DeleteFile）：清空.WNCRY文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#5311-sub_401000getrecyclepathandtempdirectorypath%e8%8e%b7%e5%8f%96%e4%b8%a4%e4%b8%aa%e8%b7%af%e5%be%84" onclick="collapseOthers(`#5311-sub_401000getrecyclepathandtempdirectorypath获取两个路径-nav`)" id="5311-sub_401000getrecyclepathandtempdirectorypath获取两个路径-nav">
									5.3.1.1 sub_401000（GetRecyclePathAndTempDirectoryPath）：获取两个路径
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5312-sub_402014findfirstfilew%e9%81%8d%e5%8e%86%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#5312-sub_402014findfirstfilew遍历文件-nav`)" id="5312-sub_402014findfirstfilew遍历文件-nav">
									5.3.1.2 sub_402014（FindFirstFileW）：遍历文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#5313-sub_402008deletefilew%e5%88%a0%e9%99%a4%e6%96%87%e4%bb%b6" onclick="collapseOthers(`#5313-sub_402008deletefilew删除文件-nav`)" id="5313-sub_402008deletefilew删除文件-nav">
									5.3.1.3 sub_402008（DeleteFileW）：删除文件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#54-taskseexe-%e5%88%86%e6%9e%90%e5%b1%80%e9%83%a8%e5%8a%9f%e8%83%bd" onclick="collapseOthers(`#54-taskseexe-分析局部功能-nav`)" id="54-taskseexe-分析局部功能-nav">
									5.4 taskse.exe 分析——局部功能
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#541-sub_401000changeprivilege_%e6%9b%b4%e6%94%b9%e6%9d%83%e9%99%90%e5%87%bd%e6%95%b0" onclick="collapseOthers(`#541-sub_401000changeprivilege_更改权限函数-nav`)" id="541-sub_401000changeprivilege_更改权限函数-nav">
									5.4.1 sub_401000（ChangePrivilege_）：更改权限函数
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#6-%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88" onclick="collapseOthers(`#6-解决方案-nav`)" id="6-解决方案-nav">
									6. 解决方案
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								<ul class="collapse" data-toggle="collapse">
							
						
						
							<li>
								<a href="#61-%e6%9c%aa%e6%84%9f%e6%9f%93%e4%b8%bb%e6%9c%ba" onclick="collapseOthers(`#61-未感染主机-nav`)" id="61-未感染主机-nav">
									6.1 未感染主机
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#62-%e5%b7%b2%e6%84%9f%e6%9f%93%e4%b8%bb%e6%9c%ba" onclick="collapseOthers(`#62-已感染主机-nav`)" id="62-已感染主机-nav">
									6.2 已感染主机
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#63-%e4%b8%93%e6%9d%80%e5%b7%a5%e5%85%b7" onclick="collapseOthers(`#63-专杀工具-nav`)" id="63-专杀工具-nav">
									6.3 专杀工具
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="https://b40du.github.io">
            爆肚的杂货铺
        </a>
        
        <button type="button" class="nav-darkmode-toggle" v-on:click="toggleDarkMode">
            <i class="material-icons" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons" v-else="isDarkMode">
                brightness_7
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://b40du.github.io">
        <div class="single-column-header-title">爆肚的杂货铺</div>
        
        <div class="single-column-header-subtitle">b40du&#39;s blog</div>
        

    </a>
</div>
            <div id="content">
<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                
            >
                <div class="post-title">
                    病毒分析 之 Wannacry勒索病毒
                    
                    <div class="post-subtitle">
                        病毒分析报告-Wannacry勒索病毒-技术分享
                    </div>
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2019-11-09 22:11
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB">技术分享</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/virus-analysis">virus-analysis</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h1 id="1-前言">1. 前言</h1>
<p>WannaCry（直译“想哭”、“想解密”，俗名“魔窟”，或称WannaCrypt、WanaCrypt0r 2.0、Wanna Decryptor）是一种利用NSA的“永恒之蓝”（EternalBlue）漏洞利用程序透过互联网对全球运行Microsoft Windows操作系统的计算机进行攻击的加密型勒索软件兼蠕虫病毒（Encrypting Ransomware Worm）。该病毒利用AES-128和RSA算法恶意加密用户文件以勒索比特币，使用Tor进行通讯，为WanaCrypt0r 1.0的变种。</p>
<p>2017年5月，此程序大规模感染包括西班牙电信在内的许多西班牙公司、英国国民保健署、联邦快递和德国铁路股份公司。据报道，至少有99个国家的其他目标在同一时间遭到WanaCrypt0r 2.0的攻击（当前已有大约150个国家遭到攻击）。俄罗斯联邦内务部、俄罗斯联邦紧急情况部和俄罗斯电信公司MegaFon共有超过1000台计算机受到感染。于中国的感染甚至波及到公安机关使用的内网，国家互联网应急中心亦发布通报。</p>
<p>WannaCry被认为利用了美国国家安全局的“永恒之蓝”（EternalBlue）工具以攻击运行Microsoft Windows操作系统的计算机。“永恒之蓝”传播的勒索病毒以ONION和WNCRY两个家族为主。“永恒之蓝”利用了某些版本的微软服务器消息块（SMB）协议中的数个漏洞，而当中最严重的漏洞是允许远程计算机运行代码。修复该漏洞的安全补丁已经于此前的2017年3月14日发布，但并非所有计算机都进行了安装。</p>
<p>——from wikipedia</p>
<h1 id="2-样本概况">2. 样本概况</h1>
<table>
<thead>
<tr>
<th>项目</th>
<th>信息</th>
</tr>
</thead>
<tbody>
<tr>
<td>样本名称</td>
<td>wcry.exe</td>
</tr>
<tr>
<td>样本类型</td>
<td>PE32 executable (GUI) Intel 80386, for MS Windows</td>
</tr>
<tr>
<td>样本大小</td>
<td>3514368 Byte</td>
</tr>
<tr>
<td>MD5</td>
<td>84c82835a5d21bbcf75a61706d8ab549</td>
</tr>
<tr>
<td>SHA1</td>
<td>5ff465afaabcbf0150d1a3ab2c2e74f3a4426467</td>
</tr>
<tr>
<td>SHA256</td>
<td>ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa</td>
</tr>
</tbody>
</table>
<h1 id="3-基础分析">3. 基础分析</h1>
<h2 id="31-壳信息">3.1 壳信息</h2>
<p>如下图所示，程序没有加壳。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814004140.png" alt=""></p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814004155.png" alt=""></p>
<h2 id="32-区段信息">3.2 区段信息</h2>
<p>比较正常，看起来没有奇怪的信息。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814004231.png" alt=""></p>
<h2 id="33-加密算法信息">3.3 加密算法信息</h2>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814004251.png" alt=""></p>
<h2 id="34-导入表信息">3.4 导入表信息</h2>
<p>如下图所示，使用<code>Total Commander</code>快速查看<code>wcry.exe</code>，能够发现导入表中有<code>FinResourceA</code>、<code>LoadResource</code>、<code>LockResource</code>等函数，与资源表密切相关。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814004321.png" alt=""></p>
<h2 id="35-资源表信息">3.5 资源表信息</h2>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814004400.png" alt=""></p>
<h1 id="4-行为分析">4. 行为分析</h1>
<h2 id="41-文件操作">4.1 文件操作</h2>
<p>如下图所示，病毒在其所在文件夹内释放多个文件。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814004444.png" alt=""></p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814004500.png" alt=""></p>
<h2 id="42-注册表操作">4.2 注册表操作</h2>
<p>如下图所示，可以只有一个创建注册表键的操作。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814004529.png" alt=""></p>
<h2 id="43-进程操作">4.3 进程操作</h2>
<p>用<code>ProcessMonitor</code>查看一下进程树，发现病毒创建了多个进程，如图下所示，可以很明显的看到，进程使用<code>cmd.exe</code>执行了一个批处理的脚本文件。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814005227.png" alt=""></p>
<h2 id="44-网络操作">4.4 网络操作</h2>
<p>如下图所示，可以看到有病毒的进程在进行网络访问，<code>443</code>端口可能是建立了<code>https</code>连接，<code>9101</code>端口可能是进行特殊端口的<code>web</code>访问。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814004620.png" alt=""></p>
<h1 id="5-代码分析">5. 代码分析</h1>
<h2 id="51-wcryexe分析病毒主程序">5.1 wcry.exe分析——病毒主程序</h2>
<h3 id="511-wcryexe的主体逻辑">5.1.1 wcry.exe的主体逻辑</h3>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814004658.png" alt=""></p>
<h3 id="512-sub_401225getcharacter获取字符串">5.1.2 sub_401225（GetCharacter）：获取字符串</h3>
<p>如下图所示，病毒获取到计算机名，然后计算出计算机名的<code>ASCII</code>乘积，将这个乘积作为随机数种子，调用两次<code>rand</code>函数，最后获取倒一个字幕+数字的随机字符串。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814004740.png" alt=""></p>
<h3 id="513-sub_4010fdsetregistry设置注册表项">5.1.3 sub_4010FD（SetRegistry）：设置注册表项</h3>
<p>接着，病毒会对命令行参数做一个判断，然后切换当前进程的文件路径，来到<code>sub_4010FD</code>函数。如下图所示，病毒创建了一个注册表项，然后将当前的<code>exe</code>所在的绝对路径，添加到注册表的【<code>\HKEY_LOCAL_MACHINE\SOFTWARE</code>】路径中。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814004842.png" alt=""></p>
<p>如下图所示，之后可以看到，病毒在注册表中注册了一个名称为<code>wd</code>，类型为<code>REG_SZ</code>，数据为当前病毒的<code>exe</code>所在绝对路径的项。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814004901.png" alt=""></p>
<h3 id="514-sub_401dabfreefiles释放资源文件">5.1.4 sub_401DAB（FreeFiles）：释放资源文件</h3>
<p>如下图所示，这个函数首先将资源中隐藏的压缩包进行解压，解压密码是<code>WNcry@2017</code>，然后释放压缩包中的所有文件到当前进程的路径下。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814005146.png" alt=""></p>
<p>我们如何断定该资源是一个<code>ZIP</code>压缩包呢，可以用<code>ResourceHacker</code>看一下，如下图所示，用<code>ResourceHacker</code>工具查看<code>wcry.exe</code>的资源信息，可以发现一个类型为<code>XIA</code>，名称为<code>2058</code>的资源数据，开头为 【<code>50 4B</code>】的十六进制信息表明其是一个ZIP压缩包。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814005048.png" alt=""></p>
<p>释放后的文件如下图所示，其中<code>msg</code>是语言包。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814005116.png" alt=""></p>
<h3 id="515-sub_401e9eoverwrite重写wnry文件写入比特币账户信息">5.1.5 sub_401E9E（OverWrite）：重写wnry文件，写入比特币账户信息</h3>
<p>如下图所示，函数首先赋值局部变量为3个比特币账户的信息，然后抽取一个账户信息写入<code>c.wnry</code>文件中。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814005333.png" alt=""></p>
<p>病毒运行后可以在勒索病毒界面看到要支付的比特币账户地址。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814005357.png" alt=""></p>
<h3 id="516-sub_401064hideandcreate以不显示命令行窗口的方式执行命令">5.1.6 sub_401064（HideAndCreate）：以不显示命令行窗口的方式执行命令</h3>
<p>首先，可以看到此处执行了两次<code>HideAndCreate</code>。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814005423.png" alt=""></p>
<p>如下图所示，其中：</p>
<p>第一个<code>HideAndCreate</code>创建了一个进程，参数是【<code>attrib +h .</code>】作用是将当前路径下的所有文件设置为隐藏。</p>
<p>第二个<code>HideAndCreate</code>的参数为【<code>icacls . /grant Everyone:F /T /C /Q</code>】这条命令是给当前系统添加了一个名为<code>Everyone</code>的用户，并给这个用户所有的权限。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814005448.png" alt=""></p>
<h3 id="517-sub_40170agetapis获取api的地址">5.1.7 sub_40170A（GetAPIs）：获取API的地址</h3>
<p>首先进入函数中，如下图所示，可以很明显的看到一个<code>LoadLibraryA</code>，目的是为了导入一个<code>dll</code>文件，找到<code>ModuleName</code>，进行交叉引用查看，可以看到<code>ModuleName</code>来自<code>push</code>的一个<code>kernel32.dll</code>地址。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814005536.png" alt=""></p>
<p>如下图所示，可以看到，这个函数的主要功能就是获取后面要用的诸多函数的地址，例如<code>WriteFile</code>、<code>ReadFile</code>、<code>MoveFileW</code>、<code>MoveFileExW</code>等等。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814005556.png" alt=""></p>
<h3 id="518-sub_4012fdinitcriticalsection初始化临界区">5.1.8 sub_4012FD（InitCriticalSection）：初始化临界区</h3>
<p>临界区的作用在于保证在同一时间内只有一个线程对共享数据进行控制访问，使用<code>CRITICAL_SECTION</code>结构来定义临界区对象，使用这个结构记录系统的一些信息，来确保同一个时间只有一个线程访问该临界区保护的数据。而在创建<code>CRITICAL_SECTION</code>对象后，需要调用该函数进行临界区对象的初始化。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814005632.png" alt=""></p>
<h3 id="519-sub_401437importkeyandallocmemory导入密钥并分配全局堆内存">5.1.9 sub_401437（ImportKeyAndAllocMemory）：导入密钥并分配全局堆内存</h3>
<ol>
<li>
<p>导入<code>RSA</code>密钥，用于解密后面的文件。</p>
</li>
<li>
<p>申请两块大小为<code>0x100000</code>的全局堆内存</p>
</li>
</ol>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814005711.png" alt=""></p>
<h3 id="5110-sub_4014a6decodefile从twnry文件中解密出一个dll文件">5.1.10 sub_4014A6（DecodeFile）：从t.wnry文件中解密出一个dll文件</h3>
<p>如下图所示，函数会读取<code>t.wnry</code>文件，并进行一系列的读取解密操作，最后得到一个大小<code>0x10000</code>字节的数据，这个数据是一个<code>PE</code>文件。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814005739.png" alt=""></p>
<p>那么如何确认这段数据是一个<code>PE</code>文件呢，在<code>OD</code>中单步步过函数后，得到返回值<code>eax</code>，为解密数据的地址，我们到内存中观察，发现PE文件的两个标志，<code>0x5A4D</code>和<code>0x4550</code>。</p>
<p><img src="C:%5CNutstore%5C999-%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87%5Cimage-20200814005829801.png" alt="image-20200814005829801"></p>
<p>我们把这块数据提取出来，并用<code>010Editor</code>保存为一个任意的<code>PE</code>文件，之后用<code>PEID</code>打开，发现其实它是一个<code>dll</code>文件。</p>
<p>由此可见，这块解密出来的数据相当重要，从后面的分析可以得知，这个<code>dll</code>是病毒重中之重的部分，很多病毒的主要功能都是通过该<code>dll</code>来完成的。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814005844.png" alt=""></p>
<h3 id="5111-sub_4021bdallocandwritememory申请堆空间并写入数据">5.1.11 sub_4021BD（AllocAndWriteMemory）：申请堆空间并写入数据</h3>
<p>如下图所示，这个函数的主要功能是申请了一块虚拟内存（申请两次，不行再报错），并把刚刚解密出来的<code>NT</code>头和<code>DOS</code>头的地址存放进堆空间中。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814005910.png" alt=""></p>
<p>如下图所示，函数走完之后，在申请的堆空间内已经写好了数据，<code>001F9690</code>为<code>PE</code>头，<code>001F9694</code>为<code>Dos</code>头。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814005936.png" alt=""></p>
<h3 id="5112-sub_402924getexportfuncaddr获取导出函数的地址">5.1.12 sub_402924（GetExportFuncAddr）：获取导出函数的地址</h3>
<p>如下图所示，该函数的主要功能是遍历<code>t.wnry.dll</code>的导出表，找到<code>TaskStart</code>函数的地址并返回该地址。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010003.png" alt=""></p>
<p>到这里呢，<code>wcry.exe</code>的主要功能已经分析完毕，可以看到，该程序只是做了一些初始化的功能，没有看到其真正的病毒功能，例如感染文件，加密文件，网络连接等等，我们有理由猜测，解密出来的dll文件为病毒提供了核心功能。</p>
<p>接下来我们分析<code>t.wnry.dll</code>文件。</p>
<h2 id="52-twnrydll分析病毒核心">5.2 t.wnry.dll分析——病毒核心</h2>
<h3 id="521-twnrydll的主体逻辑">5.2.1 t.wnry.dll的主体逻辑</h3>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010040.png" alt=""></p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010057.png" alt=""></p>
<h3 id="522-sub_10004690createfirstmutex创建第一个互斥体">5.2.2 sub_10004690（CreateFirstMutex）：创建第一个互斥体</h3>
<p>如下图所示，函数创建了一个名为<code>MswinzonescachCounterMutexA</code>的互斥体，作用是实现内核中的互斥访问功能，同一时间只能有一个任务持有互斥锁，而且只有这个任务可以对互斥锁进行解锁。从而保证对临界区加以保护，以使任意时刻只有一个线程能够执行临界区的代码，实现了多线程之间的有序访问。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010134.png" alt=""></p>
<h3 id="523-sub_10001000readfiletomemory读取文件到内存">5.2.3 sub_10001000（ReadFileToMemory）：读取文件到内存</h3>
<p>比较简单的操作，读取<code>c.wnry</code>文件。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010201.png" alt=""></p>
<h3 id="524-sub_100012d0getusersidandcmpwithsys读取sid并做比较">5.2.4 sub_100012D0（GetUserSIDAndCmpWithSys）：读取SID并做比较</h3>
<p>如下图所示，该函数读取当前用户的<code>SID</code>并与系统的<code>SID</code>做比较，然后读取用户当前的用户名并与系统的用户名做比较，返回比较结果。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010226.png" alt=""></p>
<h3 id="525-sub_10004600createsecondmutex创建第二个互斥体">5.2.5 sub_10004600（CreateSecondMutex）：创建第二个互斥体</h3>
<p>也是一个简单的函数，为了区分之前创建互斥体的函数，设置为创建第二个互斥体。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010257.png" alt=""></p>
<h3 id="526-sub_10004500checkfileisexist查看文件是否存在">5.2.6 sub_10004500（CheckFileIsExist）：查看文件是否存在</h3>
<p>该函数的主要功能是查看<code>00000000.dky</code>文件是否存在。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010322.png" alt=""></p>
<h3 id="527-sub_10003ac0createpkyandeky创建两个密钥">5.2.7 sub_10003AC0（CreatePkyAndEky）：创建两个密钥</h3>
<p>如下图所示，该函数的主要功能是创建<code>00000000.pky</code>文件保存公钥，创建<code>00000000.eky</code>保存加密后的私钥。该病毒采取的是<code>RSA</code>和<code>AES</code>双重加密。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010349.png" alt=""></p>
<h3 id="528-sub_10004790createresfile创建00000000res文件">5.2.8 sub_10004790（CreateResFile）：创建00000000.res文件</h3>
<p>如图下所示，大函数套小函数，创建<code>00000000.res</code>文件并写入了<code>0x88</code>字节的数据。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010416.png" alt=""></p>
<p><img src="C:%5CNutstore%5C999-%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87%5Cimage-20200814010432747.png" alt="image-20200814010432747"></p>
<h3 id="529-sub_100045c0checkdky5s检测是否存在00000000dky">5.2.9 sub_100045C0（CheckDky5s）：检测是否存在00000000.dky</h3>
<p>该函数中套用到了之前的<code>CheckFileIsExist</code>函数，每隔5秒便检测一次<code>00000000.dky</code>文件是否存在。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010445.png" alt=""></p>
<h3 id="5210-sub_10005730encodeallfiles检测有无新磁盘并加密">5.2.10 sub_10005730（EncodeAllFiles）：检测有无新磁盘并加密</h3>
<p>该函数的主要功能是每隔3秒中，检测是否有新的磁盘，如果有，就对其进行文件加密。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010505.png" alt=""></p>
<h3 id="5211-sub_10005300runtaskdlexe隐藏的方式启动taskdlexe">5.2.11 sub_10005300（RunTaskdlExe）：隐藏的方式启动taskdl.exe</h3>
<p>如下图所示，每隔30秒以不显示命令行窗口的方式运行<code>taskdl.exe</code>程序。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010531.png" alt=""></p>
<h3 id="5212-sub_10004990runexeandsetreg运行文件和设置注册表">5.2.12 sub_10004990（RunExeAndSetReg）：运行文件和设置注册表</h3>
<p>每隔30秒启动路径下的<code>taskse.exe</code>文件和<code>@WanaDecryptor@.exe</code>文件并且使用命令行设置注册表启动项。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010554.png" alt=""></p>
<h3 id="5213-sub_10004890runtaskseanddecryptor启动两个exe文件">5.2.13 sub_10004890（RunTaskseAndDecryptor）：启动两个exe文件</h3>
<p>该函数以命令行的方式启动<code>taskse.exe</code>和<code>@WanaDecryptor@.exe</code>。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010622.png" alt=""></p>
<h3 id="5214-sub_100047f0setregedit设置注册表启动项">5.2.14 sub_100047F0（SetRegedit）：设置注册表启动项</h3>
<p>该函数将获取到的随机的ASCII码，并用于设置注册表的启动项。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010659.png" alt=""></p>
<h3 id="5215-sub_100057c0createotherfiles创建其他的文件">5.2.15 sub_100057C0（CreateOtherFiles）：创建其他的文件</h3>
<p>该函数的主要逻辑如下：</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010721.png" alt=""></p>
<h3 id="5216-sub_10004cd0createexeandlnk创建wanadecryptorexe和其lnk">5.2.16 sub_10004CD0（CreateExeAndLnk）：创建@WanaDecryptor@.exe和其.Lnk</h3>
<p>该函数先检测<code>@WanaDecryptor@.exe</code>是否存在，如果不存在，就将<code>u.wnry</code>重命名为<code>@WanaDecryptor@.exe</code>，然后再检测<code>@WanaDecryptor@.exe.lnk</code>文件是否存在，如果不存在，就创建一个批处理脚本，并给<code>@WanaDecryptor@.exe</code>创建一个快捷方式。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010742.png" alt=""></p>
<h3 id="5217-sub_10004df0createreadme创建please_read_metxt">5.2.17 sub_10004DF0（CreateReadMe）：创建@Please_Read_Me@.txt</h3>
<p>该函数先检测工作路径下是否存在<code>@Please_Read_Me@.txt</code>文件，如果不存在，就从<code>r.wnry</code>中读取内容并写入到<code>@Please_Read_Me@.txt</code>。这个文档是病毒的勒索文档。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010808.png" alt=""></p>
<h3 id="5218-sub_10005480encodeotherfiles加密其他的所有文件">5.2.18 sub_10005480（EncodeOtherFiles）：加密其他的所有文件</h3>
<p>获取Windows所有的用户名，并检测是否和自己所在User的用户名一致，如果一致则退出，不一致则加密其他用户名下的所有文件。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010829.png" alt=""></p>
<h4 id="52181-sub_100027f0encodedifferentfiles根据不同路径加密文件">5.2.18.1 sub_100027F0（EncodeDifferentFiles）：根据不同路径加密文件</h4>
<p>由上一个函数可知，该函数是根据不同的路径进行加密操作。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010852.png" alt=""></p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010916.png" alt=""></p>
<h4 id="52182-sub_10002300realencode实际加密函数1">5.2.18.2 sub_10002300（RealEncode）：实际加密函数（1）</h4>
<p>这个函数看起来很多，但主要的部分其实很明了，首先是申请堆空间，拼接出路径，然后开始遍历文件。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814010940.png" alt=""></p>
<p>先判断是哪一种文件，选择要加密的文件后，拷贝函数名，拷贝文件路径，开始加密文件，并为加密后的文件添加标记（为了解密或其他功能）。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011007.png" alt=""></p>
<h5 id="521821-sub_10002d60choosefile选择判断要加密的文件">5.2.18.2.1 sub_10002D60（ChooseFile）：选择/判断要加密的文件</h5>
<p>该函数是为了判断哪些是要加密的文件，先判断是否是<code>.exe/.dll</code>，然后判断是否是<code>.wncry</code>，然后循环判断是否为主流的20多种文件格式，如果不能快速判断，则判断是否为全部100多种文件格式，最后判断是否为<code>.wncryt</code>以及<code>.wncryr</code>文件。</p>
<p>如果是某种类型的文件，则返回相应的宽字符指针类型的整型数字<code>(wchar_*)N</code>。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011047.png" alt=""></p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011101.png" alt=""></p>
<h4 id="52183-sub_10002300realencode实际加密函数2">5.2.18.3 sub_10002300（RealEncode）：实际加密函数（2）</h4>
<p>接着回到<code>RealEncode</code>函数中，我们找到遍历下一个文件的地方<code>FindNextFileW</code>，之后可以看到针对文件类型进行的遍历已经玩造成，开始循环加密文件并添加标签。</p>
<p>之后对比并计算<code>\\</code>符号的个数，作用是计算目录层级，如果目录层级小于6层，则拷贝三种文件到当前工作路径下。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011127.png" alt=""></p>
<p>之后还能看到函数在内部调用了<code>RealEncode</code>，目的是使用递归的方式对文件加密。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011150.png" alt=""></p>
<h4 id="52184-sub_10002940realencodeothers加密其他文件">5.2.18.4 sub_10002940（RealEncodeOthers）：加密其他文件</h4>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011210.png" alt=""></p>
<h5 id="521841-sub_10002200encodefiles_再往下一层的加密">5.2.18.4.1 sub_10002200（EncodeFiles_）：再往下一层的加密</h5>
<p>首先判断文件是哪种类型，由于<code>wncyr</code>和<code>wncry</code>都是病毒作者自定义的类型，因此要判断文件是否为这两种类型。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011233.png" alt=""></p>
<h6 id="5218411-sub_10002200encodefiles__再往下一层的加密">5.2.18.4.1.1 sub_10002200（EncodeFiles__）：再往下一层的加密</h6>
<p>首先，读取原文件前8个字节比较是否是<code>WANACRY！</code>，然后判断文件类型是否为4，然后在新的文件名后面加上字符T如：<code>C:\Users\15pb-win7\Desktop\A.docx.WNCRYT</code>，再创建加密后的文件，但是此时文件内是空的。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011310.png" alt=""></p>
<p>然后依次写入8字节字符<code>WANACRY!</code>、4字节的大小、<code>0x100</code>字节的数据、文件的类型值和原文件的大小。然后将文件的后缀由<code>.WNCRYT</code>改为<code>.WNCRY</code>。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011332.png" alt=""></p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011345.png" alt=""></p>
<h6 id="5218412-sub_10002200encodefiles___再往下一层的加密">5.2.18.4.1.2 sub_10002200（EncodeFiles___）：再往下一层的加密</h6>
<p>该层加密首先解析原文件，然后每次输入16个字节通过第9层加密后输出16个字节，依次循环直到加密完成为止，然后输入加密后的缓冲区。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011424.png" alt=""></p>
<h4 id="52185-sub_10002300realencode实际加密函数3">5.2.18.5 sub_10002300（RealEncode）：实际加密函数（3）</h4>
<p>然后是加密全盘文件的操作，先获取出所有磁盘的类型，然后对固定类型的磁盘进行加密，再往下一层的加密函数是<code>EncodeAllDisk</code>。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011457.png" alt=""></p>
<h5 id="521851-sub_10005540encodealldisk再往下一层的加密加密全部固定磁盘">5.2.18.5.1 sub_10005540（EncodeAllDisk）：再往下一层的加密，加密全部固定磁盘</h5>
<p>该函数会获取磁盘的盘符如<code>C:\</code>，然后调取磁盘的临时路径，最后调用之前遇到过的加密函数，对磁盘文件进行加密。然后加密所有的用户磁盘，显示勒索信息，填充磁盘。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011528.png" alt=""></p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200816155935.png" alt=""></p>
<h2 id="53-taskdlexe-分析局部功能">5.3 taskdl.exe 分析——局部功能</h2>
<p><code>Taskdl.exe</code>的主要逻辑如下：</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011556.png" alt=""></p>
<h3 id="531-sub_401080deletefile清空wncry文件">5.3.1 sub_401080（DeleteFile）：清空.WNCRY文件</h3>
<h4 id="5311-sub_401000getrecyclepathandtempdirectorypath获取两个路径">5.3.1.1 sub_401000（GetRecyclePathAndTempDirectoryPath）：获取两个路径</h4>
<p>首先<code>GetRecyclePathAndTempDirectoryPath</code>返回两个路径，第一个是回收站的路径，第二个是系统盘的临时文件夹的路径。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011615.png" alt=""></p>
<h4 id="5312-sub_402014findfirstfilew遍历文件">5.3.1.2 sub_402014（FindFirstFileW）：遍历文件</h4>
<p>接着，函数会调用<code>FindFirstFileW</code>函数来查找目标文件夹中所有的<code>.WNCRYPT</code>结尾的文件。如果没有找到，释放内存；如果找到文件则：</p>
<ol>
<li>拼接目标文件的完整路径</li>
<li>获取目标文件完整路径的长度</li>
<li>拷贝目标路径</li>
<li>将路径和长度写入容器中</li>
<li>接着查找下一个文件，直到遍历结束</li>
</ol>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011704.png" alt=""></p>
<h4 id="5313-sub_402008deletefilew删除文件">5.3.1.3 sub_402008（DeleteFileW）：删除文件</h4>
<p>文件遍历结束，调用<code>DeleteFileW</code>来删除所有的<code>.WNCYPT</code>结尾的文件。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011725.png" alt=""></p>
<p>删除目标文件结束后，在函数的末尾将容器清空，然后使用<code>FreeMemory</code>释放内存。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011746.png" alt=""></p>
<p>至此，<code>taskdl.exe</code>基本分析完毕。</p>
<h2 id="54-taskseexe-分析局部功能">5.4 taskse.exe 分析——局部功能</h2>
<p><code>taskse.exe</code>的主要逻辑如下：</p>
<p>首先判断参数是否符合要求，然后进入<code>ChangePrivilege</code>函数。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011815.png" alt=""></p>
<p>进入<code>ChangePrivilege</code>函数后进行一系列的导入dll文件和获取函数地址的准备工作，进入<code>ChangePrivilege_</code>这个主功能函数。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011835.png" alt=""></p>
<h3 id="541-sub_401000changeprivilege_更改权限函数">5.4.1 sub_401000（ChangePrivilege_）：更改权限函数</h3>
<p>该函数首先获取了必要的<code>API</code>函数地址。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011904.png" alt=""></p>
<p>然后获取当前进程伪句柄，并打开该进程的访问令牌，获取<code>LUID</code>，然后创建一个新的访问令牌，对这个新的令牌进行权限提升。可以得知该函数的主要功能就是提权。</p>
<p><img src="https://development-bj-01.oss-cn-beijing.aliyuncs.com/PicGo/20200814011921.png" alt=""></p>
<h1 id="6-解决方案">6. 解决方案</h1>
<h2 id="61-未感染主机">6.1 未感染主机</h2>
<ol>
<li>及时对系统打补丁。</li>
<li>及时对关键的文件进行备份。</li>
<li><code>445</code>，<code>135</code>，<code>137</code>，<code>139</code>端口，防止病毒对漏洞进行利用进行端口传播。</li>
<li>关闭电脑打印机共享。</li>
<li>关闭<code>SMBv1</code>，清除<code>SMB 1.0/CIFS 文件共享支持</code>。</li>
</ol>
<h2 id="62-已感染主机">6.2 已感染主机</h2>
<ol>
<li>立即断网。中毒机器禁止使用u盘、移动硬盘等设备，防止移动传染。</li>
<li>使用专杀工具进行查杀</li>
</ol>
<h2 id="63-专杀工具">6.3 专杀工具</h2>
<p>详见专杀工具。</p>

                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">Last modified on 2019-11-09</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="https://b40du.github.io/posts/note-aqniu-network-engineer/">
			Next<br>笔记-网络工程师
                </a>
                
                
                
                <a class="older-posts" href="https://b40du.github.io/posts/report-vul-efs-web-server-7.2/">
			Previous<br>漏洞分析 之 EFS Web Server 7.2 获取HTTP请求SEH缓冲区溢出
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                







            </div>
        </div>
    </div>
</div>

            </div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	This is a customized copyright.
	
</div>
            </div>
    <script>
let app;

app = new Vue({
    el: '#app',
    data: {
        scrollY: 0,
        navOpacity: 0,
        isDrawerOpen: false,
        mounted: false,
        isDarkMode: false
    },
    methods: {
            sgn(t, x) {
                let k = 1. / (1. - 2 * t);
                if (x <= t) return 0;
                else if (x >= 1 - t) return 1;
                else {
                    return k * (x - t);
                }
            },
            handleScroll() {
                this.scrollY = window.scrollY;
                this.navOpacity = this.sgn(.0, Math.min(1, Math.max(0, window.scrollY / (this.pageHeadHeight() - this.navBarHeight() * 0.8))));
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;

                if (this.navOpacity >= 1) {
                    navBackground.style.opacity = 1;
                    navTitle.style.opacity = 1;
                } else {
                    navBackground.style.opacity = 0;
                    navTitle.style.opacity = 0;
                }
            },
            handleResize() {
                const {navBar, navBackground, navTitle, extraContainer, streamContainer} = this.$refs;
                extraContainer.style.left = (streamContainer.offsetWidth - extraContainer.offsetWidth) + 'px';
            },
            navBarHeight() {
                return this.$refs.navBar.offsetHeight;
            },
            pageHeadHeight() {
                return this.$refs.pageHead.offsetHeight;
            },
            toggleDrawer() {
                this.isDrawerOpen = !this.isDrawerOpen;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            closeDrawer() {
                this.isDrawerOpen = false;
                document.getElementsByTagName('html')[0].style.overflow = this.isDrawerOpen ? 'hidden' : 'unset';
            },
            toggleDarkMode() {
                this.isDarkMode = !this.isDarkMode;
                if (this.isDarkMode==true){
                    document.cookie = "night=1;path=/";
                    document.body.classList.add("night");
                } else {
                    document.cookie = "night=0;path=/";
                    document.body.classList.remove("night");
                }
            }
    },
    created() {
        window.addEventListener('scroll', this.handleScroll);
        window.addEventListener('resize', this.handleResize);
        window._nonDesktop = function () {
            let check = false;
            (function (a) {
                if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true;
            })(navigator.userAgent || navigator.vendor || window.opera);
            return check;
        };
        
        var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        if (night==""){
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                
            }
        }else{
            
            if (night=="1") {
                this.toggleDarkMode();
            }
        }
    },
    mounted() {
        this.handleScroll();
        this.handleResize();
        this.mounted = true;

        
    },
    destroyed() {
        window.removeEventListener('scroll', this.handleScroll);
        window.removeEventListener('resize', this.handleResize);
    }
});
</script>

<script src="https://b40du.github.io/js/journal.js"></script>
    </body>
</html>
